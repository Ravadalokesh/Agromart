<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>My Profile - AgroMart</title>
    <link rel="icon" href="images/convertico-logo2.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <!-- External CSS Files (served from src/ at root) -->
    <link rel="stylesheet" href="styles/variables.css" />
    <link rel="stylesheet" href="styles/common.css" />
    <link rel="stylesheet" href="styles/header.css" />
    <link rel="stylesheet" href="styles/footer.css" />
    <link rel="stylesheet" href="styles/responsive.css" />
    <style>
      .profile-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .profile-header {
        background: linear-gradient(135deg, var(--primary-light), var(--accent));
        color: white;
        padding: 3rem 2rem;
        border-radius: var(--radius);
        margin-bottom: 2rem;
        text-align: center;
      }

      .profile-avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        font-size: 3rem;
        color: var(--primary-light);
        border: 4px solid rgba(255, 255, 255, 0.3);
      }

      .btn-signout {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        margin-top: 1.25rem;
        padding: 0.6rem 1.25rem;
        background: rgba(255, 255, 255, 0.25);
        color: white;
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-signout:hover {
        background: rgba(255, 255, 255, 0.4);
        border-color: white;
      }

      .profile-tabs {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid var(--border);
        flex-wrap: wrap;
      }

      .profile-tab {
        padding: 1rem 1.5rem;
        background: none;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-light);
        cursor: pointer;
        transition: var(--transition);
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
      }

      .profile-tab.active {
        color: var(--primary-light);
        border-bottom-color: var(--primary-light);
      }

      .profile-content {
        display: none;
      }

      .profile-content.active {
        display: block;
      }

      .profile-section {
        background: var(--bg-white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-light);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
      }

      .form-group input {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary-light);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .save-btn {
        padding: 0.75rem 2rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      .save-btn:hover {
        background: var(--accent);
        transform: translateY(-2px);
      }

      /* Seller specific styles */
      .earnings-card {
        background: linear-gradient(135deg, #4a9e2a, #3f7b1d);
        color: white;
        padding: 2rem;
        border-radius: var(--radius);
        margin-bottom: 2rem;
      }

      .earnings-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
      }

      .earnings-stat {
        text-align: center;
      }

      .earnings-stat-value {
        font-size: 2rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
      }

      .earnings-stat-label {
        opacity: 0.9;
        font-size: 0.9rem;
      }

      .add-product-btn {
        padding: 0.75rem 1.5rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 1.5rem;
        transition: var(--transition);
      }

      .add-product-btn:hover {
        background: var(--accent);
      }

      .product-list {
        display: grid;
        gap: 1rem;
      }

      .product-item {
        display: flex;
        gap: 1rem;
        padding: 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        align-items: center;
      }

      .product-item-image {
        width: 100px;
        height: 100px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
      }

      .product-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .product-item-details {
        flex: 1;
      }

      .product-item-actions {
        display: flex;
        gap: 0.5rem;
      }

      .btn-edit,
      .btn-delete {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      .btn-edit {
        background: var(--primary-light);
        color: white;
      }

      .btn-delete {
        background: #e74c3c;
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
      }

      .modal.active {
        display: flex;
      }

      .modal-content {
        background: white;
        border-radius: var(--radius);
        padding: 2rem;
        max-width: 600px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
      }

      .close-modal {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-light);
      }

      @media (max-width: 768px) {
        .form-row {
          grid-template-columns: 1fr;
        }

        .product-item {
          flex-direction: column;
        }

        .earnings-stats {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header will be loaded by header.js -->
    <div id="header-placeholder"></div>

    <div class="profile-container">
      <div class="profile-header" id="profileHeader">
        <div class="profile-avatar">
          <i class="bi bi-person"></i>
        </div>
        <h1 id="userName">Loading...</h1>
        <p id="userEmail"></p>
        <span id="userTypeBadge" style="display: inline-block; margin-top: 0.5rem; padding: 0.25rem 1rem; background: rgba(255,255,255,0.2); border-radius: 20px;"></span>
        <button type="button" class="btn-signout" onclick="signOut()" title="Sign out">
          <i class="bi bi-box-arrow-right"></i> Sign Out
        </button>
      </div>

      <div class="profile-tabs">
        <button class="profile-tab active" onclick="switchTab('info')">Profile Info</button>
        <button class="profile-tab" onclick="switchTab('cart')">My Cart</button>
        <button class="profile-tab" onclick="switchTab('wishlist')">Wishlist</button>
        <button class="profile-tab seller-tab" onclick="switchTab('products')" style="display: none;">My Products</button>
        <button class="profile-tab seller-tab" onclick="switchTab('earnings')" style="display: none;">Earnings</button>
        <button class="profile-tab admin-tab" onclick="window.location.href='admin-dashboard.html'" style="display: none;">
          <i class="bi bi-shield-check"></i> Admin Dashboard
        </button>
      </div>

      <!-- Profile Info Tab -->
      <div id="infoTab" class="profile-content active">
        <div id="becomeSellerSection" class="profile-section" style="display: none;">
          <h2 class="section-title">Sell on AgroMart</h2>
          <p style="margin-bottom: 1rem;">List your products and reach more customers. You can view your total products and earnings in your profile.</p>
          <button type="button" class="add-product-btn" onclick="becomeSeller()">
            <i class="bi bi-shop"></i> Start selling on AgroMart
          </button>
        </div>
        <div class="profile-section">
          <h2 class="section-title">Personal Information</h2>
          <form id="profileForm">
            <div class="form-row">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" name="firstName" id="firstName" />
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" name="lastName" id="lastName" />
              </div>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" name="email" id="email" readonly />
            </div>
            <div class="form-group">
              <label>Username</label>
              <input type="text" name="username" id="username" readonly />
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" name="phone" id="phone" />
            </div>
            <h3 class="section-title" style="margin-top: 2rem;">Address</h3>
            <div class="form-group">
              <label>Street Address</label>
              <input type="text" name="street" id="street" />
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>City</label>
                <input type="text" name="city" id="city" />
              </div>
              <div class="form-group">
                <label>State</label>
                <input type="text" name="state" id="state" />
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>PIN Code</label>
                <input type="text" name="pincode" id="pincode" />
              </div>
              <div class="form-group">
                <label>Country</label>
                <input type="text" name="country" id="country" value="India" readonly />
              </div>
            </div>
            <button type="submit" class="save-btn">Save Changes</button>
          </form>
        </div>
      </div>

      <!-- Cart Tab -->
      <div id="cartTab" class="profile-content">
        <div class="profile-section">
          <h2 class="section-title">My Cart</h2>
          <div id="cartContent">
            <!-- Cart items will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Wishlist Tab -->
      <div id="wishlistTab" class="profile-content">
        <div class="profile-section">
          <h2 class="section-title">My Wishlist</h2>
          <div id="wishlistContent">
            <!-- Wishlist items will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Products Tab (Seller only) -->
      <div id="productsTab" class="profile-content">
        <div class="profile-section">
          <h2 class="section-title">My Products</h2>
          <button class="add-product-btn" onclick="openAddProductModal()">
            <i class="bi bi-plus-circle"></i> Add New Product
          </button>
          <div id="productsContent">
            <!-- Products will be loaded here -->
          </div>
        </div>
      </div>

      <!-- Earnings Tab (Seller only) -->
      <div id="earningsTab" class="profile-content">
        <div class="earnings-card">
          <h2 style="margin-bottom: 1rem;">Total Earnings</h2>
          <div class="earnings-stats">
            <div class="earnings-stat">
              <div class="earnings-stat-value" id="totalEarnings">₹0</div>
              <div class="earnings-stat-label">Total Earnings</div>
            </div>
            <div class="earnings-stat">
              <div class="earnings-stat-value" id="totalSold">0</div>
              <div class="earnings-stat-label">Items Sold</div>
            </div>
            <div class="earnings-stat">
              <div class="earnings-stat-value" id="totalProducts">0</div>
              <div class="earnings-stat-label">Products Listed</div>
            </div>
          </div>
        </div>
        <div class="profile-section">
          <h2 class="section-title">Product Earnings</h2>
          <div id="earningsContent">
            <!-- Earnings breakdown will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal" id="productModal">
      <div class="modal-content">
        <div class="modal-header">
          <h2 id="modalTitle">Add New Product</h2>
          <button class="close-modal" onclick="closeProductModal()">&times;</button>
        </div>
        <form id="productForm" onsubmit="saveProduct(event)">
          <div class="form-group">
            <label>Product Name *</label>
            <input type="text" name="name" required />
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea name="description" rows="3" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px;"></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Price (₹) *</label>
              <input type="number" name="price" step="0.01" required />
            </div>
            <div class="form-group">
              <label>Stock Quantity *</label>
              <input type="number" name="stock" required />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Category *</label>
              <select name="category" id="productCategorySelect" required style="width: 100%; padding: 0.75rem; border: 2px solid var(--border); border-radius: 8px;">
                <option value="">Select Category</option>
                <option value="vegetables-fruits">Vegetables & Fruits</option>
                <option value="grains-pulses">Grains & Pulses</option>
                <option value="seeds-fertilizers">Seeds & Fertilizers</option>
                <option value="tools-equipment">Tools & Equipment</option>
                <option value="livestock">Livestock</option>
                <option value="other">Other (Custom)</option>
              </select>
            </div>
            <div class="form-group">
              <label>Subcategory</label>
              <input type="text" name="subcategory" />
            </div>
          </div>
          <div class="form-group" id="customCategoryGroup" style="display: none;">
            <label>Custom Category *</label>
            <input type="text" name="customCategory" id="customCategoryInput" placeholder="Enter new category name" />
          </div>
          <div class="form-group">
            <label>Image URL</label>
            <input type="url" name="image" placeholder="https://example.com/image.jpg" />
          </div>
          <button type="submit" class="save-btn">Save Product</button>
        </form>
      </div>
    </div>

    <!-- Footer will be loaded by footer.js -->
    <div id="footer-placeholder"></div>

    <!-- Component Scripts -->
    <script src="components/header.js"></script>
    <script src="components/footer.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/wishlist.js"></script>

    <!-- Profile Page Script -->
    <script>
      let currentUser = null;
      let editingProductId = null;

      async function signOut() {
        try {
          await fetch('/api/logout', { method: 'POST', credentials: 'include' });
        } catch (e) {}
        window.location.href = '/';
      }

      async function becomeSeller() {
        try {
          var res = await fetch('/api/user/become-seller', { method: 'PUT', credentials: 'include' });
          if (res.ok) {
            currentUser = await res.json();
            loadProfile();
            alert('You are now a seller! You can add products from the My Products tab.');
          } else {
            var err = await res.json().catch(function() { return {}; });
            alert(err.error || 'Could not become a seller');
          }
        } catch (e) {
          alert('Request failed');
        }
      }

      // Load user profile
      async function loadUserProfile() {
        try {
          // const response = await fetch('/api/user');
            const response = await fetch('/api/user', {
              credentials: 'include'
            });

          if (!response.ok) {
            window.location.href = 'index.html';
            return;
          }
          currentUser = await response.json();
          loadProfile();
        } catch (error) {
          window.location.href = 'index.html';
        }
      }

      function switchTab(tab) {
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.profile-content').forEach(c => c.classList.remove('active'));

        const tabBtn = document.querySelector(`[onclick="switchTab('${tab}')"]`);
        const tabContent = document.getElementById(`${tab}Tab`);
        if (!tabBtn || !tabContent || tabBtn.style.display === 'none') {
          return;
        }

        tabBtn.classList.add('active');
        tabContent.classList.add('active');

        if (tab === 'cart') loadCart();
        if (tab === 'wishlist') loadWishlist();
        if (tab === 'products') loadProducts();
        if (tab === 'earnings') loadEarnings();
      }

      function loadProfile() {
        if (!currentUser) return;

        document.getElementById('userName').textContent = 
          `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim() || currentUser.username;
        document.getElementById('userEmail').textContent = currentUser.email;
        
        const badge = document.getElementById('userTypeBadge');
        const becomeSellerSection = document.getElementById('becomeSellerSection');
        const sellerTabs = document.querySelectorAll('.seller-tab');
        const adminTabs = document.querySelectorAll('.admin-tab');
        
        // Get cart and wishlist tab buttons
        const cartTab = document.querySelector('[onclick="switchTab(\'cart\')"]');
        const wishlistTab = document.querySelector('[onclick="switchTab(\'wishlist\')"]');

        if (currentUser.userType === 'seller') {
          badge.textContent = 'Seller';
          sellerTabs.forEach(function(el) { el.style.display = 'block'; });
          if (becomeSellerSection) becomeSellerSection.style.display = 'none';
          // Show cart and wishlist for sellers
          if (cartTab) cartTab.style.display = 'block';
          if (wishlistTab) wishlistTab.style.display = 'block';
        } else if (currentUser.userType === 'admin') {
          badge.textContent = 'Admin';
          sellerTabs.forEach(function(el) { el.style.display = 'block'; });
          adminTabs.forEach(function(el) { el.style.display = 'block'; });
          if (becomeSellerSection) becomeSellerSection.style.display = 'none';
          // Hide cart and wishlist tabs for admin
          if (cartTab) cartTab.style.display = 'none';
          if (wishlistTab) wishlistTab.style.display = 'none';
        } else {
          badge.textContent = 'Customer';
          if (becomeSellerSection) becomeSellerSection.style.display = 'block';
          // Show cart and wishlist for regular users
          if (cartTab) cartTab.style.display = 'block';
          if (wishlistTab) wishlistTab.style.display = 'block';
        }

        // Fill form
        document.getElementById('firstName').value = currentUser.firstName || '';
        document.getElementById('lastName').value = currentUser.lastName || '';
        document.getElementById('email').value = currentUser.email || '';
        document.getElementById('username').value = currentUser.username || '';
        document.getElementById('phone').value = currentUser.phone || '';
        
        if (currentUser.address) {
          document.getElementById('street').value = currentUser.address.street || '';
          document.getElementById('city').value = currentUser.address.city || '';
          document.getElementById('state').value = currentUser.address.state || '';
          document.getElementById('pincode').value = currentUser.address.pincode || '';
          document.getElementById('country').value = currentUser.address.country || 'India';
        }

        if (!window.__profileTabApplied) {
          const requestedTab = new URLSearchParams(window.location.search).get('tab');
          if (requestedTab) {
            window.__profileTabApplied = true;
            switchTab(requestedTab);
          }
        }
      }

      async function loadCart() {
        try {
          const response = await fetch('/api/cart');
          const cart = await response.json();
          const cartContent = document.getElementById('cartContent');

          if (cart.length === 0) {
            cartContent.innerHTML = '<p>Your cart is empty.</p>';
            return;
          }

          cartContent.innerHTML = cart.map(item => `
            <div class="product-item">
              <div class="product-item-image">
                <img src="${item.image || 'images/home-pages pics/seeds.jpg'}" alt="${item.name}" />
              </div>
              <div class="product-item-details">
                <h3>${item.name}</h3>
                <p>₹${item.price.toLocaleString('en-IN')} x ${item.quantity}</p>
                <p><strong>Total: ₹${(item.price * item.quantity).toLocaleString('en-IN')}</strong></p>
              </div>
              <div class="product-item-actions">
                <button class="btn-edit" onclick="updateCartQuantity('${item.productId}', ${item.quantity - 1})">-</button>
                <span style="padding: 0.5rem 1rem;">${item.quantity}</span>
                <button class="btn-edit" onclick="updateCartQuantity('${item.productId}', ${item.quantity + 1})">+</button>
                <button class="btn-delete" onclick="removeFromCart('${item.productId}')">Remove</button>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading cart:', error);
        }
      }

      async function loadWishlist() {
        try {
          const response = await fetch('/api/wishlist');
          const wishlist = await response.json();
          const wishlistContent = document.getElementById('wishlistContent');

          if (wishlist.length === 0) {
            wishlistContent.innerHTML = '<p>Your wishlist is empty.</p>';
            return;
          }

          wishlistContent.innerHTML = wishlist.map(item => `
            <div class="product-item">
              <div class="product-item-image">
                <img src="${item.image || 'images/home-pages pics/seeds.jpg'}" alt="${item.name}" />
              </div>
              <div class="product-item-details">
                <h3>${item.name}</h3>
                <p>₹${item.price.toLocaleString('en-IN')}</p>
              </div>
              <div class="product-item-actions">
                <button class="btn-delete" onclick="removeFromWishlist('${item.productId}')">Remove</button>
              </div>
            </div>
          `).join('');
        } catch (error) {
          console.error('Error loading wishlist:', error);
        }
      }

      async function loadProducts() {
        try {
          const response = await fetch('/api/products/seller');
          const products = await response.json();
          const productsContent = document.getElementById('productsContent');

          if (products.length === 0) {
            productsContent.innerHTML = '<p>You haven\'t added any products yet.</p>';
            return;
          }

          productsContent.innerHTML = `
            <div class="product-list">
              ${products.map(product => `
                <div class="product-item">
                  <div class="product-item-image">
                    <img src="${product.image || 'images/home-pages pics/seeds.jpg'}" alt="${product.name}" />
                  </div>
                  <div class="product-item-details">
                    <h3>${product.name}</h3>
                    <p>₹${product.price.toLocaleString('en-IN')} | Stock: ${product.stock} | Sold: ${product.sold}</p>
                    <p style="color: var(--text-light); font-size: 0.9rem;">${product.description || ''}</p>
                    <p style="margin-top: 0.5rem;">
                      <span style="padding: 0.25rem 0.75rem; background: ${product.approved ? '#4a9e2a' : '#f39c12'}; color: white; border-radius: 20px; font-size: 0.85rem;">
                        ${product.approved ? '✓ Approved' : '⏳ Pending Approval'}
                      </span>
                    </p>
                  </div>
                  <div class="product-item-actions">
                    <button class="btn-edit" onclick="editProduct('${product._id}')">Edit</button>
                    <button class="btn-delete" onclick="deleteProduct('${product._id}')">Delete</button>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } catch (error) {
          console.error('Error loading products:', error);
        }
      }

      async function loadEarnings() {
        try {
          const endpoint = currentUser && currentUser.userType === 'admin'
            ? '/api/admin/earnings'
            : '/api/seller/earnings';
          const response = await fetch(endpoint, { credentials: 'include' });
          const earnings = await response.json().catch(() => ({}));

          if (!response.ok) {
            throw new Error(earnings.error || 'Failed to load earnings');
          }

          let list = earnings.productsList || earnings.products || [];
          const totalEarnings = Number(earnings.totalEarnings ?? earnings.totalRevenue ?? 0);
          const totalSold = Number(earnings.totalSold ?? earnings.totalItemsSold ?? 0);
          let totalProducts = Array.isArray(list)
            ? list.length
            : Number(earnings.totalProducts ?? earnings.products ?? 0);

          // Keep admin earnings product count aligned with "My Products" tab source.
          if (currentUser && currentUser.userType === 'admin') {
            const adminProductsRes = await fetch('/api/products/seller', { credentials: 'include' });
            if (adminProductsRes.ok) {
              const adminProducts = await adminProductsRes.json();
              if (Array.isArray(adminProducts)) {
                list = adminProducts;
                totalProducts = adminProducts.length;
              }
            }
          }

          document.getElementById('totalEarnings').textContent = `\u20B9${totalEarnings.toLocaleString('en-IN')}`;
          document.getElementById('totalSold').textContent = totalSold;
          document.getElementById('totalProducts').textContent = totalProducts;

          const earningsContent = document.getElementById('earningsContent');
          if (!Array.isArray(list) || list.length === 0) {
            earningsContent.innerHTML = '<p>No products yet.</p>';
            return;
          }

          earningsContent.innerHTML = `
            <div class="product-list">
              ${list.map(product => `
                <div class="product-item">
                  <div class="product-item-details">
                    <h3>${product.name}</h3>
                    <p>Sold: ${Number(product.sold || 0)} units | Earnings: \u20B9${Number(product.earnings || 0).toLocaleString('en-IN')}</p>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
        } catch (error) {
          console.error('Error loading earnings:', error);
        }
      }

      async function updateCartQuantity(productId, quantity) {
        try {
          await fetch(`/api/cart/${productId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ quantity })
          });
          loadCart();
        } catch (error) {
          console.error('Error updating cart:', error);
        }
      }

      async function removeFromCart(productId) {
        try {
          await fetch(`/api/cart/${productId}`, { method: 'DELETE' });
          loadCart();
        } catch (error) {
          console.error('Error removing from cart:', error);
        }
      }

      async function removeFromWishlist(productId) {
        try {
          await fetch(`/api/wishlist/${productId}`, { method: 'DELETE' });
          loadWishlist();
        } catch (error) {
          console.error('Error removing from wishlist:', error);
        }
      }

      function openAddProductModal() {
        editingProductId = null;
        document.getElementById('modalTitle').textContent = 'Add New Product';
        document.getElementById('productForm').reset();
        document.getElementById('productModal').classList.add('active');
      }

      function closeProductModal() {
        document.getElementById('productModal').classList.remove('active');
        editingProductId = null;
      }

      async function saveProduct(event) {
        event.preventDefault();
        const formData = new FormData(event.target);
        let category = formData.get('category');
        if (category === 'other') {
          category = (formData.get('customCategory') || '').trim();
          if (!category) {
            alert('Please enter a custom category name.');
            return;
          }
        }
        const data = {
          name: formData.get('name'),
          description: formData.get('description'),
          price: parseFloat(formData.get('price')),
          stock: parseInt(formData.get('stock')),
          category,
          subcategory: formData.get('subcategory'),
          image: formData.get('image')
        };

        try {
          const url = editingProductId ? `/api/products/${editingProductId}` : '/api/products';
          const method = editingProductId ? 'PUT' : 'POST';

          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            closeProductModal();
            if (!editingProductId) {
              alert('Product submitted successfully! It will be visible to customers once approved by admin.');
            } else {
              alert('Product updated successfully!');
            }
            loadProducts();
          } else {
            alert('Error saving product');
          }
        } catch (error) {
          console.error('Error saving product:', error);
          alert('Error saving product');
        }
      }

      async function editProduct(productId) {
        try {
          const response = await fetch('/api/products/seller');
          const products = await response.json();
          const product = products.find(p => p._id === productId);

          if (product) {
            editingProductId = productId;
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.querySelector('[name="name"]').value = product.name;
            document.querySelector('[name="description"]').value = product.description || '';
            document.querySelector('[name="price"]').value = product.price;
            document.querySelector('[name="stock"]').value = product.stock;
            document.querySelector('[name="category"]').value = product.category;
            document.querySelector('[name="subcategory"]').value = product.subcategory || '';
            document.querySelector('[name="image"]').value = product.image || '';
            document.getElementById('productModal').classList.add('active');
          }
        } catch (error) {
          console.error('Error loading product:', error);
        }
      }

      async function deleteProduct(productId) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
          const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
          if (response.ok) {
            loadProducts();
          }
        } catch (error) {
          console.error('Error deleting product:', error);
        }
      }

      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = {
          firstName: formData.get('firstName'),
          lastName: formData.get('lastName'),
          phone: formData.get('phone'),
          address: {
            street: formData.get('street'),
            city: formData.get('city'),
            state: formData.get('state'),
            pincode: formData.get('pincode'),
            country: formData.get('country')
          }
        };

        try {
          const response = await fetch('/api/user', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
          });

          if (response.ok) {
            currentUser = await response.json();
            loadProfile();
            alert('Profile updated successfully!');
          }
        } catch (error) {
          console.error('Error updating profile:', error);
        }
      });

      // Close modal on outside click
      document.getElementById('productModal').addEventListener('click', (e) => {
        if (e.target.id === 'productModal') {
          closeProductModal();
        }
      });

      // Initialize
      loadUserProfile();

      // Toggle custom category input based on dropdown selection
      (function () {
        const categorySelect = document.getElementById('productCategorySelect');
        const customGroup = document.getElementById('customCategoryGroup');
        if (!categorySelect || !customGroup) return;
        categorySelect.addEventListener('change', function () {
          if (this.value === 'other') {
            customGroup.style.display = 'block';
          } else {
            customGroup.style.display = 'none';
            const input = document.getElementById('customCategoryInput');
            if (input) input.value = '';
          }
        });
      })();
      
    </script>
  </body>
</html>







