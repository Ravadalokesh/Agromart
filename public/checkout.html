<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Checkout - AgroMart</title>
    <link rel="icon" href="images/convertico-logo2.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <!-- External CSS Files (served from src/ at root) -->
    <link rel="stylesheet" href="styles/variables.css" />
    <link rel="stylesheet" href="styles/common.css" />
    <link rel="stylesheet" href="styles/header.css" />
    <link rel="stylesheet" href="styles/footer.css" />
    <link rel="stylesheet" href="styles/responsive.css" />
    <style>
      .checkout-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .checkout-header {
        margin-bottom: 2rem;
      }

      .checkout-header h1 {
        font-size: 2rem;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
      }

      .checkout-content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
      }

      .checkout-section {
        background: var(--bg-white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 2rem;
      }

      .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--primary-light);
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
        transition: var(--transition);
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--primary-light);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
      }

      .order-summary {
        background: var(--bg-white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow-sm);
        height: fit-content;
        position: sticky;
        top: 100px;
      }

      .order-item {
        display: flex;
        gap: 1rem;
        padding: 1rem 0;
        border-bottom: 1px solid var(--border);
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .order-item-image {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
      }

      .order-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .order-item-details {
        flex: 1;
      }

      .order-item-name {
        font-weight: 600;
        margin-bottom: 0.25rem;
      }

      .order-item-price {
        color: var(--primary-light);
        font-weight: 700;
      }

      .summary-total {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid var(--primary-light);
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.75rem;
      }

      .summary-row.total {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--primary-dark);
      }

      .place-order-btn {
        width: 100%;
        padding: 1rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        margin-top: 1.5rem;
        transition: var(--transition);
      }

      .place-order-btn:hover {
        background: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 158, 42, 0.3);
      }

      .payment-methods {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1rem;
      }

      .payment-method {
        border: 2px solid var(--border);
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: var(--transition);
        text-align: center;
      }

      .payment-method:hover,
      .payment-method.selected {
        border-color: var(--primary-light);
        background: var(--bg-light);
      }

      @media (max-width: 968px) {
        .checkout-content {
          grid-template-columns: 1fr;
        }

        .order-summary {
          position: static;
        }

        .form-row {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header will be loaded by header.js -->
    <div id="header-placeholder"></div>

    <div class="checkout-container">
      <div class="checkout-header">
        <h1>Checkout</h1>
        <p style="color: var(--text-light);">Complete your order</p>
      </div>

      <div class="checkout-content">
        <div>
          <div class="checkout-section">
            <h2 class="section-title">Delivery Address</h2>
            <form id="checkoutForm">
              <div class="form-row">
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" required />
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" required />
                </div>
              </div>
              <div class="form-group">
                <label>Phone Number *</label>
                <input type="tel" required />
              </div>
              <div class="form-group">
                <label>Address *</label>
                <textarea rows="3" required></textarea>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>City *</label>
                  <input type="text" required />
                </div>
                <div class="form-group">
                  <label>State *</label>
                  <input type="text" required />
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label>PIN Code *</label>
                  <input type="text" required />
                </div>
                <div class="form-group">
                  <label>Country</label>
                  <input type="text" value="India" readonly />
                </div>
              </div>
            </form>
          </div>

          <div class="checkout-section">
            <h2 class="section-title">Payment Method</h2>
            <div class="payment-methods">
              <div class="payment-method selected" onclick="selectPayment(this)">
                <i class="bi bi-credit-card" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                <span>Card</span>
              </div>
              <div class="payment-method" onclick="selectPayment(this)">
                <i class="bi bi-wallet2" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                <span>UPI</span>
              </div>
              <div class="payment-method" onclick="selectPayment(this)">
                <i class="bi bi-cash-coin" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                <span>Cash on Delivery</span>
              </div>
              <div class="payment-method" onclick="selectPayment(this)">
                <i class="bi bi-bank" style="font-size: 2rem; display: block; margin-bottom: 0.5rem;"></i>
                <span>Net Banking</span>
              </div>
            </div>
          </div>
        </div>

        <div class="order-summary">
          <h2 class="section-title">Order Summary</h2>
          <div id="orderItems">
            <!-- Order items will be loaded here -->
          </div>
          <div class="summary-total">
            <div class="summary-row">
              <span>Subtotal</span>
              <span id="subtotal">₹0</span>
            </div>
            <div class="summary-row">
              <span>Delivery Charges</span>
              <span>₹50</span>
            </div>
            <div class="summary-row total">
              <span>Total</span>
              <span id="total">₹0</span>
            </div>
          </div>
          <button class="place-order-btn" onclick="placeOrder()">
            <i class="bi bi-check-circle"></i> Place Order
          </button>
        </div>
      </div>
    </div>

    <!-- Footer will be loaded by footer.js -->
    <div id="footer-placeholder"></div>

    <!-- Component Scripts -->
    <script src="components/header.js"></script>
    <script src="components/footer.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/wishlist.js"></script>

    <!-- Checkout Page Script -->
    <script>
      let orderItems = [];

      function selectPayment(element) {
        document.querySelectorAll('.payment-method').forEach(el => el.classList.remove('selected'));
        element.classList.add('selected');
      }

      async function renderOrderItems() {
        try {
          // Check if buy now product exists
          const buyNowProduct = sessionStorage.getItem('buy_now_product');
          
          if (buyNowProduct) {
            orderItems = [JSON.parse(buyNowProduct)];
            sessionStorage.removeItem('buy_now_product');
          } else {
            const response = await fetch('/api/cart');
            if (!response.ok) {
              if (response.status === 401) {
                window.location.href = '/';
                return;
              }
              throw new Error('Failed to load cart');
            }
            orderItems = await response.json();
          }

          const orderItemsDiv = document.getElementById('orderItems');
          const subtotalEl = document.getElementById('subtotal');
          const totalEl = document.getElementById('total');

          if (orderItems.length === 0) {
            orderItemsDiv.innerHTML = '<p>No items in order</p>';
            return;
          }

          const itemsHTML = orderItems.map(item => `
            <div class="order-item">
              <div class="order-item-image">
                <img src="${item.image || 'images/home-pages pics/seeds.jpg'}" alt="${item.name}" />
              </div>
              <div class="order-item-details">
                <div class="order-item-name">${item.name}</div>
                <div class="order-item-price">₹${(item.price * (item.quantity || 1)).toLocaleString('en-IN')}</div>
                ${item.quantity ? `<div style="color: var(--text-light); font-size: 0.9rem;">Qty: ${item.quantity}</div>` : ''}
              </div>
            </div>
          `).join('');

          orderItemsDiv.innerHTML = itemsHTML;

          const subtotal = orderItems.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0);
          const delivery = 50;
          const total = subtotal + delivery;

          subtotalEl.textContent = `₹${subtotal.toLocaleString('en-IN')}`;
          totalEl.textContent = `₹${total.toLocaleString('en-IN')}`;
        } catch (error) {
          console.error('Error rendering order items:', error);
        }
      }

      async function placeOrder() {
        const form = document.getElementById('checkoutForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const formData = new FormData(form);
        const selectedPayment = document.querySelector('.payment-method.selected')?.textContent.trim() || 'Card';

        const orderData = {
          products: orderItems.map(item => ({
            productId: item.id || item.productId,
            name: item.name,
            price: item.price,
            quantity: item.quantity || 1
          })),
          total: orderItems.reduce((sum, item) => sum + (item.price * (item.quantity || 1)), 0) + 50,
          deliveryAddress: {
            firstName: formData.get('firstName') || '',
            lastName: formData.get('lastName') || '',
            phone: formData.get('phone') || '',
            address: formData.get('address') || '',
            city: formData.get('city') || '',
            state: formData.get('state') || '',
            pincode: formData.get('pincode') || '',
            country: formData.get('country') || 'India'
          },
          paymentMethod: selectedPayment
        };

        try {
          const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
          });

          const data = await response.json().catch(() => ({}));

          if (response.ok) {
            alert('Order placed successfully! Thank you for your purchase.');
            window.location.href = 'home.html';
          } else {
            alert(data.error || 'Error placing order. Please try again.');
          }
        } catch (error) {
          console.error('Error placing order:', error);
          alert('Error placing order. Please try again.');
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        renderOrderItems();
      });
    </script>
  </body>
</html>
