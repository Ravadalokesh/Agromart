<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Reset Password - AgroMart</title>
    <link rel="icon" href="images/convertico-logo2.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <!-- External CSS Files (served from src/ at root) -->
    <link rel="stylesheet" href="styles/variables.css" />
    <link rel="stylesheet" href="styles/common.css" />
    <style>
      .reset-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        padding: 2rem;
      }

      .reset-card {
        background: white;
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        padding: 3rem;
        max-width: 450px;
        width: 100%;
      }

      .reset-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .reset-header i {
        font-size: 3rem;
        color: var(--primary-light);
        margin-bottom: 1rem;
      }

      .reset-header h1 {
        font-size: 1.75rem;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
      }

      .reset-header p {
        color: var(--text-light);
        font-size: 0.95rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text-dark);
      }

      .form-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid #c5c5c5;
        border-radius: 10px;
        font-size: 1rem;
        transition: var(--transition);
        background: #fff;
        box-sizing: border-box;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }

      .form-group input:hover {
        border-color: #a8a8a8;
      }

      .form-group input:focus {
        outline: none;
        border-color: var(--primary-light);
        border-width: 2px;
        box-shadow: 0 0 0 3px rgba(63, 123, 29, 0.15);
      }

      .password-strength {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        display: none;
      }

      .password-strength.show {
        display: block;
      }

      .password-strength.weak {
        color: #e74c3c;
      }

      .password-strength.medium {
        color: #f39c12;
      }

      .password-strength.strong {
        color: #27ae60;
      }

      .password-requirements {
        background: var(--bg-light);
        padding: 1rem;
        border-radius: 8px;
        margin-top: 0.5rem;
        font-size: 0.85rem;
      }

      .password-requirements ul {
        list-style: none;
        margin: 0;
        padding: 0;
      }

      .password-requirements li {
        padding: 0.25rem 0;
        color: var(--text-light);
      }

      .password-requirements li i {
        margin-right: 0.5rem;
      }

      .password-requirements li.valid {
        color: var(--accent);
      }

      .submit-btn {
        width: 100%;
        padding: 1rem;
        background: var(--primary-light);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        margin-top: 1rem;
      }

      .submit-btn:hover:not(:disabled) {
        background: var(--accent);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(74, 158, 42, 0.3);
      }

      .submit-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .error-message {
        background: #fee;
        color: #c33;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: none;
        border: 1px solid #f5c6cb;
      }

      .error-message.show {
        display: block;
      }

      .success-message {
        background: #efe;
        color: #2d6a2d;
        padding: 0.75rem 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: none;
        border: 1px solid #c3e6cb;
        text-align: center;
      }

      .success-message.show {
        display: block;
      }

      .back-to-login {
        text-align: center;
        margin-top: 1.5rem;
      }

      .back-to-login a {
        color: var(--primary-light);
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
      }

      .back-to-login a:hover {
        color: var(--accent);
        text-decoration: underline;
      }

      @media (max-width: 768px) {
        .reset-card {
          padding: 2rem 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="reset-container">
      <div class="reset-card">
        <div class="reset-header">
          <i class="bi bi-shield-lock"></i>
          <h1>Reset Password</h1>
          <p>Enter your new password below</p>
        </div>

        <div class="error-message" id="resetError"></div>
        <div class="success-message" id="resetSuccess"></div>

        <form id="resetPasswordForm" onsubmit="handleResetPassword(event)">
          <div class="form-group">
            <label>New Password</label>
            <input type="password" name="password" id="newPassword" required minlength="6" oninput="checkPasswordStrength()" />
            <div class="password-strength" id="passwordStrength"></div>
            <div class="password-requirements">
              <ul id="passwordRequirements">
                <li id="reqLength"><i class="bi bi-circle"></i> At least 6 characters</li>
                <li id="reqLetter"><i class="bi bi-circle"></i> Contains a letter</li>
                <li id="reqNumber"><i class="bi bi-circle"></i> Contains a number</li>
              </ul>
            </div>
          </div>

          <div class="form-group">
            <label>Confirm Password</label>
            <input type="password" name="confirmPassword" id="confirmPassword" required minlength="6" oninput="checkPasswordMatch()" />
            <div class="password-strength" id="passwordMatch"></div>
          </div>

          <button type="submit" class="submit-btn" id="submitBtn">Reset Password</button>
        </form>

        <div class="back-to-login">
          <a href="/">Back to Login</a>
        </div>
      </div>
    </div>

    <script>
      // API base URL
      const API_BASE =
        window.location.protocol === "http:" ||
        window.location.protocol === "https:"
          ? window.location.origin
          : "http://localhost:3000";

      function apiUrl(path) {
        return API_BASE + (path.startsWith("/") ? path : "/" + path);
      }

      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      const resetToken = urlParams.get("token");

      if (!resetToken) {
        document.getElementById("resetError").textContent = "Invalid reset link. Please request a new password reset.";
        document.getElementById("resetError").classList.add("show");
        document.getElementById("resetPasswordForm").style.display = "none";
      }

      function checkPasswordStrength() {
        const password = document.getElementById("newPassword").value;
        const strengthDiv = document.getElementById("passwordStrength");
        const reqLength = document.getElementById("reqLength");
        const reqLetter = document.getElementById("reqLetter");
        const reqNumber = document.getElementById("reqNumber");

        // Check requirements
        const hasLength = password.length >= 6;
        const hasLetter = /[a-zA-Z]/.test(password);
        const hasNumber = /[0-9]/.test(password);

        // Update requirement indicators
        if (hasLength) {
          reqLength.classList.add("valid");
          reqLength.querySelector("i").className = "bi bi-check-circle-fill";
        } else {
          reqLength.classList.remove("valid");
          reqLength.querySelector("i").className = "bi bi-circle";
        }

        if (hasLetter) {
          reqLetter.classList.add("valid");
          reqLetter.querySelector("i").className = "bi bi-check-circle-fill";
        } else {
          reqLetter.classList.remove("valid");
          reqLetter.querySelector("i").className = "bi bi-circle";
        }

        if (hasNumber) {
          reqNumber.classList.add("valid");
          reqNumber.querySelector("i").className = "bi bi-check-circle-fill";
        } else {
          reqNumber.classList.remove("valid");
          reqNumber.querySelector("i").className = "bi bi-circle";
        }

        // Calculate strength
        if (password.length === 0) {
          strengthDiv.classList.remove("show");
          return;
        }

        let strength = 0;
        if (hasLength) strength++;
        if (hasLetter) strength++;
        if (hasNumber) strength++;
        if (password.length >= 8) strength++;
        if (/[!@#$%^&*]/.test(password)) strength++;

        strengthDiv.classList.add("show");
        strengthDiv.classList.remove("weak", "medium", "strong");

        if (strength <= 2) {
          strengthDiv.className = "password-strength show weak";
          strengthDiv.textContent = "Weak password";
        } else if (strength <= 4) {
          strengthDiv.className = "password-strength show medium";
          strengthDiv.textContent = "Medium password";
        } else {
          strengthDiv.className = "password-strength show strong";
          strengthDiv.textContent = "Strong password";
        }

        checkPasswordMatch();
      }

      function checkPasswordMatch() {
        const password = document.getElementById("newPassword").value;
        const confirmPassword = document.getElementById("confirmPassword").value;
        const matchDiv = document.getElementById("passwordMatch");

        if (confirmPassword.length === 0) {
          matchDiv.classList.remove("show");
          return;
        }

        matchDiv.classList.add("show");

        if (password === confirmPassword) {
          matchDiv.className = "password-strength show strong";
          matchDiv.textContent = "Passwords match";
        } else {
          matchDiv.className = "password-strength show weak";
          matchDiv.textContent = "Passwords do not match";
        }
      }

      async function handleResetPassword(event) {
        event.preventDefault();
        const errorDiv = document.getElementById("resetError");
        const successDiv = document.getElementById("resetSuccess");
        errorDiv.classList.remove("show");
        successDiv.classList.remove("show");

        const formData = new FormData(event.target);
        const newPassword = formData.get("password");
        const confirmPassword = formData.get("confirmPassword");

        // Validate passwords match
        if (newPassword !== confirmPassword) {
          errorDiv.textContent = "Passwords do not match";
          errorDiv.classList.add("show");
          return;
        }

        // Validate password strength
        const hasLength = newPassword.length >= 6;
        const hasLetter = /[a-zA-Z]/.test(newPassword);
        const hasNumber = /[0-9]/.test(newPassword);

        if (!hasLength || !hasLetter || !hasNumber) {
          errorDiv.textContent = "Password must be at least 6 characters and contain both letters and numbers";
          errorDiv.classList.add("show");
          return;
        }

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.textContent = "Resetting...";

        try {
          const response = await fetch(apiUrl("/api/reset-password"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token: resetToken, newPassword }),
          });

          const result = await response.json().catch(() => ({}));

          if (response.ok) {
            successDiv.innerHTML = '<i class="bi bi-check-circle-fill" style="margin-right: 0.5rem;"></i>Password reset successfully! Redirecting to login...';
            successDiv.classList.add("show");
            document.getElementById("resetPasswordForm").style.display = "none";
            
            setTimeout(() => {
              window.location.href = "/";
            }, 2000);
          } else {
            errorDiv.textContent = result.error || "Failed to reset password";
            errorDiv.classList.add("show");
            submitBtn.disabled = false;
            submitBtn.textContent = "Reset Password";
          }
        } catch (error) {
          errorDiv.textContent = 'Cannot connect to server. Please make sure the server is running.';
          errorDiv.classList.add("show");
          submitBtn.disabled = false;
          submitBtn.textContent = "Reset Password";
        }
      }
    </script>
  </body>
</html>
