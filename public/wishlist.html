<!doctype html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>My Wishlist - AgroMart</title>
    <link rel="icon" href="images/convertico-logo2.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" />
    <!-- External CSS Files (served from src/ at root) -->
    <link rel="stylesheet" href="styles/variables.css" />
    <link rel="stylesheet" href="styles/common.css" />
    <link rel="stylesheet" href="styles/header.css" />
    <link rel="stylesheet" href="styles/footer.css" />
    <link rel="stylesheet" href="styles/responsive.css" />
    <link rel="stylesheet" href="styles/product-cards.css" />
    <style>
      .wishlist-container {
        max-width: 1200px;
        margin: 2rem auto;
        padding: 0 2rem;
      }

      .wishlist-header {
        margin-bottom: 2rem;
      }

      .wishlist-header h1 {
        font-size: 2rem;
        color: var(--primary-dark);
        margin-bottom: 0.5rem;
      }

      .wishlist-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 2rem;
      }

      .wishlist-item {
        background: var(--bg-white);
        border-radius: var(--radius);
        overflow: hidden;
        transition: var(--transition);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        position: relative;
      }

      .wishlist-item:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary-light);
      }

      .wishlist-item-image {
        position: relative;
        height: 200px;
        overflow: hidden;
        background: var(--bg-light);
      }

      .wishlist-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: var(--transition);
      }

      .wishlist-item:hover .wishlist-item-image img {
        transform: scale(1.1);
      }

      .remove-wishlist-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 10;
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .remove-wishlist-btn:hover {
        background: white;
        transform: scale(1.1);
      }

      .remove-wishlist-btn i {
        color: #e74c3c;
        font-size: 1.1rem;
      }

      .wishlist-item-body {
        padding: 1.5rem;
      }

      .wishlist-item-name {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }

      .wishlist-item-price {
        font-size: 1.5rem;
        font-weight: 800;
        color: var(--primary-light);
        margin-bottom: 1rem;
      }

      .wishlist-item-actions {
        display: flex;
        gap: 0.5rem;
      }

      .wishlist-item-actions button {
        flex: 1;
        padding: 0.75rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.9rem;
      }

      .btn-add-cart-wishlist {
        background: var(--bg-light);
        color: var(--primary-light);
        border: 2px solid var(--primary-light);
      }

      .btn-add-cart-wishlist:hover {
        background: var(--primary-light);
        color: white;
      }

      .btn-buy-now-wishlist {
        background: var(--primary-light);
        color: white;
      }

      .btn-buy-now-wishlist:hover {
        background: var(--accent);
      }

      .empty-wishlist {
        text-align: center;
        padding: 4rem 2rem;
        background: var(--bg-white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-sm);
      }

      .empty-wishlist i {
        font-size: 4rem;
        color: var(--text-light);
        margin-bottom: 1rem;
      }

      .empty-wishlist h2 {
        color: var(--text-dark);
        margin-bottom: 1rem;
      }

      .empty-wishlist p {
        color: var(--text-light);
        margin-bottom: 2rem;
      }

      .continue-shopping {
        display: inline-block;
        padding: 0.75rem 2rem;
        background: var(--primary-light);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: var(--transition);
      }

      .continue-shopping:hover {
        background: var(--accent);
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .wishlist-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 1rem;
        }

        .wishlist-item-actions {
          flex-direction: column;
        }
      }

      @media (max-width: 480px) {
        .wishlist-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header will be loaded by header.js -->
    <div id="header-placeholder"></div>

    <div class="wishlist-container">
      <div class="wishlist-header">
        <h1>My Wishlist</h1>
        <p style="color: var(--text-light);">Your saved items</p>
      </div>

      <div id="wishlistContent">
        <!-- Wishlist items will be loaded here -->
      </div>
    </div>

    <!-- Footer will be loaded by footer.js -->
    <div id="footer-placeholder"></div>

    <!-- Component Scripts -->
    <script src="components/header.js"></script>
    <script src="components/footer.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/admin-restrictions.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/wishlist.js"></script>

    <!-- Wishlist Page Script -->
    <script>
      async function renderWishlist() {
        try {
          const response = await fetch('/api/wishlist');
          if (!response.ok) {
            if (response.status === 401) {
              window.location.href = 'index.html';
              return;
            }
            throw new Error('Failed to load wishlist');
          }

          const wishlist = await response.json();
          const wishlistContent = document.getElementById('wishlistContent');

          if (wishlist.length === 0) {
            wishlistContent.innerHTML = `
              <div class="empty-wishlist">
                <i class="bi bi-heart"></i>
                <h2>Your wishlist is empty</h2>
                <p>Start adding items you love to your wishlist!</p>
                <a href="home.html" class="continue-shopping">Continue Shopping</a>
              </div>
            `;
            return;
          }

          const itemsHTML = wishlist.map(item => `
            <div class="wishlist-item" data-product-id="${item.productId}">
              <div class="wishlist-item-image">
                <img src="${item.image || 'images/home-pages pics/seeds.jpg'}" alt="${item.name}" />
                <button class="remove-wishlist-btn" onclick="removeFromWishlist('${item.productId}')" title="Remove from wishlist">
                  <i class="bi bi-heart-fill"></i>
                </button>
              </div>
              <div class="wishlist-item-body">
                <h3 class="wishlist-item-name">${item.name}</h3>
                <div class="wishlist-item-price">â‚¹${item.price.toLocaleString('en-IN')}</div>
                <div class="wishlist-item-actions">
                  <button class="btn-add-cart-wishlist" onclick="addToCartFromWishlist('${item.productId}')">
                    <i class="bi bi-cart-plus"></i> Add to Cart
                  </button>
                  <button class="btn-buy-now-wishlist" onclick="buyNowFromWishlist('${item.productId}')">
                    <i class="bi bi-bag-check"></i> Buy Now
                  </button>
                </div>
              </div>
            </div>
          `).join('');

          wishlistContent.innerHTML = `<div class="wishlist-grid">${itemsHTML}</div>`;
        } catch (error) {
          console.error('Error rendering wishlist:', error);
        }
      }

      async function removeFromWishlist(productId) {
        try {
          const response = await fetch(`/api/wishlist/${productId}`, {
            method: 'DELETE'
          });

          if (response.ok) {
            renderWishlist();
            if (window.wishlistManager) {
              window.wishlistManager.loadWishlist();
            }
          }
        } catch (error) {
          console.error('Error removing from wishlist:', error);
        }
      }

      async function addToCartFromWishlist(productId) {
        try {
          const response = await fetch('/api/wishlist');
          const wishlist = await response.json();
          const item = wishlist.find(p => p.productId === productId);
          
          if (item) {
            await fetch('/api/cart', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                productId: item.productId,
                name: item.name,
                price: item.price,
                image: item.image
              })
            });
            alert(`${item.name} added to cart!`);
          }
        } catch (error) {
          console.error('Error adding to cart:', error);
        }
      }

      function buyNowFromWishlist(productId) {
        fetch('/api/wishlist')
          .then(res => res.json())
          .then(wishlist => {
            const item = wishlist.find(p => p.productId === productId);
            if (item) {
              sessionStorage.setItem('buy_now_product', JSON.stringify({
                id: item.productId,
                name: item.name,
                price: item.price,
                image: item.image,
                quantity: 1
              }));
              window.location.href = 'checkout.html';
            }
          })
          .catch(error => console.error('Error:', error));
      }

      document.addEventListener('DOMContentLoaded', function() {
        renderWishlist();
      });
    </script>
  </body>
</html>
